<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with individual mapping files • ROMOPMappingTools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with individual mapping files">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ROMOPMappingTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/filesFormat.html">Tables description and rules</a></li>
    <li><a class="dropdown-item" href="../articles/workAsGithubRepo.html">Running the complete mapping process</a></li>
    <li><a class="dropdown-item" href="../articles/workWithMultipleMappingFiles.html">Step by step example using individual functions</a></li>
    <li><a class="dropdown-item" href="../articles/workWithOneMappingFile.html">Working with individual mapping files</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with individual mapping files</h1>
            
      

      <div class="d-none name"><code>workWithOneMappingFile.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://finomop.github.io/ROMOPMappingTools/">ROMOPMappingTools</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="intro">Intro<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>This vignette shows how to use some of the functions of the
ROMOPMappingTools package to work with a single Usagi mapping file.
Reading and Usagi file, validating its format, or updating it after a
vocabulary update. For trasforming a single usagi file into C&amp;CR
tables of the OMOP vocabulary, we recommend follow the same steps as in
the <a href="workWithMultipleMappingFiles.html">Work with multiple
mapping files</a> vignette. This is because the process need some other
information that is not included in the Usagi file, but n the
‘vocabularies.csv’ file. For automating all the process in a github
repository, please refer to the <a href="workAsGithubRepo.html">Work as
a github repository</a> vignette.</p>
<p>Example files are included in the package. In the
<code>inst/testdata</code> folder you can find the files used in this
example.</p>
<div class="section level3">
<h3 id="reading-a-usagi-file">Reading a Usagi file<a class="anchor" aria-label="anchor" href="#reading-a-usagi-file"></a>
</h3>
<p>For reading the Usagi file, we can use the <code>readUsagiFile</code>
function, which returns a tibble with the correct columns formated. It
can read a standard Usagi file or an extended Usagi file, see the <a href="usagiFileFormat.html">Usagi file format</a> vignette for more
details. In this example we will read a extended Usagi file, from the
test data. This file contains the mappings for the ICD10fi
vocabulary.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToUsagiFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata/VOCABULARIES/ICD10fi/ICD10fi.usagi.csv"</span>, package <span class="op">=</span> <span class="st">"ROMOPMappingTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usagiTibble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readUsagiFile.html">readUsagiFile</a></span><span class="op">(</span><span class="va">pathToUsagiFile</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usagiTibble</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 3,945</span></span>
<span><span class="co">#&gt; Columns: 25</span></span>
<span><span class="co">#&gt; $ sourceCode                        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "A01.0+G01"<span style="color: #949494;">, </span>"A01.0+I39.8"<span style="color: #949494;">, </span>"A01.0+J…</span></span>
<span><span class="co">#&gt; $ sourceName                        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Meningitis (in) typhoid fever"<span style="color: #949494;">, </span>"En…</span></span>
<span><span class="co">#&gt; $ sourceFrequency                   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> -1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>-1<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ sourceAutoAssignedConceptIds      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceConceptId`        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2000500101<span style="color: #949494;">, </span>2000500102<span style="color: #949494;">, </span>2000500103<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceName_fi`          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Lavantautiin liittyvä aivokalvotule…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceConceptClass`     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "ICD10fi Hierarchy"<span style="color: #949494;">, </span>"ICD10fi Hierar…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceDomain`           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Condition"<span style="color: #949494;">, </span>"Condition"<span style="color: #949494;">, </span>"Condition…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceValidStartDate`   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 1900-01-01<span style="color: #949494;">, </span>1900-01-01<span style="color: #949494;">, </span>1900-01-01<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceValidEndDate`     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2099-12-31<span style="color: #949494;">, </span>2099-12-31<span style="color: #949494;">, </span>2099-12-31<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceParents`          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "A01|A01.0|G01"<span style="color: #949494;">, </span>"A01|A01.0|I39.8"<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ `ADD_INFO:sourceParentVocabulary` <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "ICD10|ICD10|ICD10"<span style="color: #949494;">, </span>"ICD10|ICD10|IC…</span></span>
<span><span class="co">#&gt; $ matchScore                        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.00<span style="color: #949494;">, </span>0.00<span style="color: #949494;">, </span>0.00<span style="color: #949494;">, </span>0.78<span style="color: #949494;">, </span>0.00<span style="color: #949494;">, </span>0.00<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ mappingStatus                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "APPROVED"<span style="color: #949494;">, </span>"APPROVED"<span style="color: #949494;">, </span>"APPROVED"<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ equivalence                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "EQUAL"<span style="color: #949494;">, </span>"EQUAL"<span style="color: #949494;">, </span>"EQUAL"<span style="color: #949494;">, </span>"EQUIVALE…</span></span>
<span><span class="co">#&gt; $ statusSetBy                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "PKo"<span style="color: #949494;">, </span>"PKo"<span style="color: #949494;">, </span>"PKo"<span style="color: #949494;">, </span>"PKo"<span style="color: #949494;">, </span>"PKo"<span style="color: #949494;">, </span>"…</span></span>
<span><span class="co">#&gt; $ statusSetOn                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.666794e+12<span style="color: #949494;">, </span>1.666794e+12<span style="color: #949494;">, </span>1.666794…</span></span>
<span><span class="co">#&gt; $ conceptId                         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 4100102<span style="color: #949494;">, </span>4111401<span style="color: #949494;">, </span>4166072<span style="color: #949494;">, </span>80316<span style="color: #949494;">, </span>43…</span></span>
<span><span class="co">#&gt; $ conceptName                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Meningitis due to typhoid fever"<span style="color: #949494;">, </span>"…</span></span>
<span><span class="co">#&gt; $ domainId                          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Condition"<span style="color: #949494;">, </span>"Condition"<span style="color: #949494;">, </span>"Condition…</span></span>
<span><span class="co">#&gt; $ mappingType                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "MAPS_TO"<span style="color: #949494;">, </span>"MAPS_TO"<span style="color: #949494;">, </span>"MAPS_TO"<span style="color: #949494;">, </span>"MA…</span></span>
<span><span class="co">#&gt; $ comment                           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ createdBy                         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "TAYS"<span style="color: #949494;">, </span>"TAYS"<span style="color: #949494;">, </span>"TAYS"<span style="color: #949494;">, </span>"PKo"<span style="color: #949494;">, </span>"TAYS…</span></span>
<span><span class="co">#&gt; $ createdOn                         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.623974e+12<span style="color: #949494;">, </span>1.623974e+12<span style="color: #949494;">, </span>1.623974…</span></span>
<span><span class="co">#&gt; $ assignedReviewer                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>…</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="validating-a-usagi-file">Validating a Usagi file<a class="anchor" aria-label="anchor" href="#validating-a-usagi-file"></a>
</h3>
<p>To validate if all the information in the Usagi file is correct, we
can use the <code>validateUsagiFile</code> function. This function takes
an Usagi or Usagi-extended file and and performs a series of
validations, see the function help for more details
<code><a href="../reference/validateUsagiFile.html">?validateUsagiFile</a></code>. The function also needs a connection to
the OMOP vocabulary database and schema to where the vocabulary tables
are stored in order to make some of the validations. The function also
need the number used to offset the source concept ids in the Usagi file.
The function returns a tibble with a summary of the validations
conducted and if error are found, a new Usagi file with the errors will
be created in the specified path.</p>
<p>For this example, we will use the test database in DuckDB format
included in the package. This test database contains only the ICD10
vocabulary with all the keys in other tables (see
<code>inst/testdata/createTestData.R</code> for more details).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToOMOPVocabularyDuckDBfile</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/helper_createATemporaryCopyOfTheOMOPVocabularyDuckDB.html">helper_createATemporaryCopyOfTheOMOPVocabularyDuckDB</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span></span>
<span>    dbms <span class="op">=</span> <span class="st">"duckdb"</span>,</span>
<span>    server <span class="op">=</span> <span class="va">pathToOMOPVocabularyDuckDBfile</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="co">#&gt; Connecting using DuckDB driver</span></span>
<span><span class="va">vocabularyDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"main"</span></span>
<span></span>
<span><span class="va">pathToValidatedUsagiFile</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">"usagi_validated.csv"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validationsSummary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validateUsagiFile.html">validateUsagiFile</a></span><span class="op">(</span></span>
<span>  <span class="va">pathToUsagiFile</span>,</span>
<span>  <span class="va">connection</span>,</span>
<span>  <span class="va">vocabularyDatabaseSchema</span>,</span>
<span>  pathToValidatedUsagiFile <span class="op">=</span> <span class="va">pathToValidatedUsagiFile</span>, </span>
<span>  sourceConceptIdOffset <span class="op">=</span> <span class="fl">2000500000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">validationsSummary</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="10%">
<col width="78%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">step</th>
<th align="left">message</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing default columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceCode is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceCode and conceptId are not unique</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceName is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceName is more than 255 characters</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceFrequency is not empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is not valid</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus conceptId is 0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus with concepts outdated</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with concepts outdated</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Missing C&amp;CR columns</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is not a number on the range</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is more than 20 characters</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is not a valid domain</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with valid domain
combination</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus with valid domain
combination</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing date columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceValidStartDate is after SourceValidEndDate</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing parent columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Invalid parent concept code</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>In this case the Usagi file is valid and no errors are found. Hence,
the new validated Usagi file remains unchanged.</p>
<p>However, we can see what happens with a usagi file with errors. In
this case we use an other Usagi file with all type of errors, wich is
included in the package for unit testing purposes.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToUsagiFileWithErrors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata/VOCABULARIES/ICD10fi/ICD10fi_with_errors.usagi.csv"</span>, package <span class="op">=</span> <span class="st">"ROMOPMappingTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usagiTibbleWithErrors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readUsagiFile.html">readUsagiFile</a></span><span class="op">(</span><span class="va">pathToUsagiFileWithErrors</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validationsSummaryWithErrors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validateUsagiFile.html">validateUsagiFile</a></span><span class="op">(</span></span>
<span>  <span class="va">pathToUsagiFileWithErrors</span>,</span>
<span>  <span class="va">connection</span>,</span>
<span>  <span class="va">vocabularyDatabaseSchema</span>,</span>
<span>  pathToValidatedUsagiFile <span class="op">=</span> <span class="va">pathToValidatedUsagiFile</span>,</span>
<span>  sourceConceptIdOffset <span class="op">=</span> <span class="fl">2000500000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">validationsSummaryWithErrors</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="3%">
<col width="25%">
<col width="70%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">step</th>
<th align="left">message</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing default columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceCode is empty</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">SourceCode and conceptId are not unique</td>
<td align="left">Number of failed rules: 2</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceName is empty</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">SourceName is more than 255 characters</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceFrequency is not empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is not valid</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">APPROVED mappingStatus conceptId is 0</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">APPROVED mappingStatus with concepts outdated</td>
<td align="left">3 conceptIds do not exist on the target vocabularies, 3
conceptNames are outdated, 3 domainIds are outdated, 8 standardConcepts
have changed to non-standard</td>
</tr>
<tr class="odd">
<td align="left">WARNING</td>
<td align="left">Not APPROVED mappingStatus with concepts outdated</td>
<td align="left">3 conceptIds do not exist on the target vocabularies, 1
conceptNames are outdated, 3 domainIds are outdated, 5 standardConcepts
have changed to non-standard</td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Missing C&amp;CR columns</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">SourceConceptId is empty</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceConceptId is not a number on the range</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">SourceConceptClass is empty</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceConceptClass is more than 20 characters</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">ERROR</td>
<td align="left">SourceDomain is empty</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceDomain is not a valid domain</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">WARNING</td>
<td align="left">Not APPROVED mappingStatus with valid domain
combination</td>
<td align="left">Found 1 codes with invalid domain combinations</td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">APPROVED mappingStatus with valid domain
combination</td>
<td align="left">Found 1 codes with invalid domain combinations</td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing date columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">SourceValidStartDate is after SourceValidEndDate</td>
<td align="left">Number of failed rules: 1</td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing parent columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">Invalid parent concept code</td>
<td align="left">Found 3 codes with invalid parent concept codes</td>
</tr>
</tbody>
</table>
<p>In this case, if we open the new validate Usagi with the Usagi
software these mapping with errors will appear as FLAGGED. Additionally,
the <code>ADD_INFO:validationMessages</code> column will indicate the
exact error or errors found.</p>
<div class="float">
<img src="./img/Usagi_with_errors.png" alt="Usagi with errors"><div class="figcaption">Usagi with errors</div>
</div>
</div>
<div class="section level3">
<h3 id="updating-a-usagi-file">Updating a Usagi file<a class="anchor" aria-label="anchor" href="#updating-a-usagi-file"></a>
</h3>
<p>If the vocabulary has been updated since the Usagi file was created,
it may happen that some of the mappings are outdated. This will be
detected by the <code>validateUsagiFile</code> and show as a “ConceptIds
outdated” error.</p>
<p>In this case we will use an other Usagi file with outdated concept
ids, which is included in the package for unit testing purposes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToOutdatedUsagiFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata/VOCABULARIES/ICD10fi/ICD10fi_outdated.usagi.csv"</span>, package <span class="op">=</span> <span class="st">"ROMOPMappingTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">validationsSummaryWithErrors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validateUsagiFile.html">validateUsagiFile</a></span><span class="op">(</span></span>
<span>  <span class="va">pathToOutdatedUsagiFile</span>,</span>
<span>  <span class="va">connection</span>,</span>
<span>  <span class="va">vocabularyDatabaseSchema</span>,</span>
<span>  pathToValidatedUsagiFile <span class="op">=</span> <span class="va">pathToValidatedUsagiFile</span>,</span>
<span>  sourceConceptIdOffset <span class="op">=</span> <span class="fl">2000500000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">validationsSummaryWithErrors</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="4%">
<col width="33%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">step</th>
<th align="left">message</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing default columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceCode is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceCode and conceptId are not unique</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceName is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceName is more than 255 characters</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceFrequency is not empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is not valid</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus conceptId is 0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">APPROVED mappingStatus with concepts outdated</td>
<td align="left">122 conceptNames are outdated, 92 domainIds are
outdated, 24 standardConcepts have changed to non-standard</td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with concepts outdated</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Missing C&amp;CR columns</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is not a number on the range</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is more than 20 characters</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is not a valid domain</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with valid domain
combination</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus with valid domain
combination</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing date columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceValidStartDate is after SourceValidEndDate</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing parent columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Invalid parent concept code</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>If outdated error are detected, we can attempt to update the Usagi
file automatically using the <code>updateUsagiFile</code> function. This
function takes an Usagi or Usagi-extended file, a connection to the
database, the schema with the vocabulary tables and a path to a file
where to store the updated Usagi file.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToUpdatedUsagiFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">"usagi_updated.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">updateSummary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/updateUsagiFile.html">updateUsagiFile</a></span><span class="op">(</span></span>
<span>    <span class="va">pathToOutdatedUsagiFile</span>, </span>
<span>    <span class="va">connection</span>,</span>
<span>    <span class="va">vocabularyDatabaseSchema</span>,</span>
<span>    <span class="va">pathToUpdatedUsagiFile</span>,</span>
<span>    skipValidation <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: method with signature 'DBIConnection#SQL' chosen for function 'dbQuoteIdentifier',</span></span>
<span><span class="co">#&gt;  target signature 'DatabaseConnectorDbiConnection#SQL'.</span></span>
<span><span class="co">#&gt;  "DatabaseConnectorConnection#character" would also be valid</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">updateSummary</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="22%">
<col width="69%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">step</th>
<th align="left">message</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">INFO</td>
<td align="left">Updated conceptIds</td>
<td align="left">Updated 20 conceptIds that don’t need review</td>
</tr>
<tr class="even">
<td align="left">WARNING</td>
<td align="left">Updated conceptIds</td>
<td align="left">29 conceptIds could not be updated automatically,
remapping needed</td>
</tr>
<tr class="odd">
<td align="left">INFO</td>
<td align="left">Updated domains</td>
<td align="left">Updated 38 domains</td>
</tr>
<tr class="even">
<td align="left">INFO</td>
<td align="left">Updated concept names</td>
<td align="left">Updated 100 concept names</td>
</tr>
</tbody>
</table>
<p>This fuction updates changes in <code>domain_id</code>,
<code>concept_name</code> and if the mapped <code>concept_id</code>
point to a non-standard concept it will try to find a new mapping for it
(This is done by looking at the relationship table for relationships of
the old concept_id by “Maps to”, “Concept replaced by”, “Concept same_as
to” and “Concept poss_eq to” in that order). A new column
<code>ADD_INFO:autoUpdatingInfo</code> is added to the updated Usagi
file to show the specific changes made to the file.</p>
<p>Some times, like in this case, a new concept_id can not be found,
this is shown as a warning.</p>
<p>The new updates Usagi file can be validated again with the
<code>validateUsagiFile</code> function to check if there are any
errors.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validationsSummaryWithErrors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validateUsagiFile.html">validateUsagiFile</a></span><span class="op">(</span></span>
<span>  <span class="va">pathToUpdatedUsagiFile</span>,</span>
<span>  <span class="va">connection</span>,</span>
<span>  <span class="va">vocabularyDatabaseSchema</span>,</span>
<span>  pathToValidatedUsagiFile <span class="op">=</span> <span class="va">pathToValidatedUsagiFile</span>,</span>
<span>  sourceConceptIdOffset <span class="op">=</span> <span class="fl">2000500000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">validationsSummaryWithErrors</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="7%">
<col width="50%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">step</th>
<th align="left">message</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing default columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceCode is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceCode and conceptId are not unique</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceName is empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceName is more than 255 characters</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceFrequency is not empty</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">MappingStatus is not valid</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus conceptId is 0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">APPROVED mappingStatus with concepts outdated</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with concepts outdated</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Missing C&amp;CR columns</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptId is not a number on the range</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceConceptClass is more than 20 characters</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is empty</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceDomain is not a valid domain</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Not APPROVED mappingStatus with valid domain
combination</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ERROR</td>
<td align="left">APPROVED mappingStatus with valid domain
combination</td>
<td align="left">Found 6 codes with invalid domain combinations</td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing date columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">SourceValidStartDate is after SourceValidEndDate</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">SUCCESS</td>
<td align="left">Missing parent columns</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">SUCCESS</td>
<td align="left">Invalid parent concept code</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>Unfortunatelly, sometimes the updateUsagiFile is introducing new
errors, in this case updates in the vocabulary have introduced invalid
domain combinations. Moreover, some of the mappings could not be updated
because the new concept_id was not found. This need to be fixed by the
user by reviewing the Usagi file.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Javier Gracia-Tabuenca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
